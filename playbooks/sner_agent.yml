---
- name: sner agent local deployment
  hosts: localhost

  tasks:
    - import_role:
        name: sner_install

    - name: add agent
      shell:
        cmd: |
          set -e
          umask 077
          . venv/bin/activate && bin/server auth add-agent | awk '{print $(NF)}' > /etc/sner-ansible/sner_agent_apikey
        chdir: /opt/sner
        creates: /etc/sner-ansible/sner_agent_apikey

    - import_role:
        name: sner_agent
